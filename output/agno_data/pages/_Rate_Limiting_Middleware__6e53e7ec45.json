{
  "title": "=== Rate Limiting Middleware ===",
  "content": "class RateLimitMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Rate limiting middleware that limits requests per IP address.\n    \"\"\"\n\ndef __init__(self, app, requests_per_minute: int = 60, window_size: int = 60):\n        super().__init__(app)\n        self.requests_per_minute = requests_per_minute\n        self.window_size = window_size\n        # Store request timestamps per IP\n        self.request_history: Dict[str, deque] = defaultdict(lambda: deque())\n\nasync def dispatch(self, request: Request, call_next) -> Response:\n        # Get client IP\n        client_ip = request.client.host if request.client else \"unknown\"\n        current_time = time.time()\n\n# Clean old requests outside the window\n        history = self.request_history[client_ip]\n        while history and current_time - history[0] > self.window_size:\n            history.popleft()\n\n# Check if rate limit exceeded\n        if len(history) >= self.requests_per_minute:\n            return JSONResponse(\n                status_code=429,\n                content={\n                    \"detail\": f\"Rate limit exceeded. Max {self.requests_per_minute} requests per minute.\"\n                },\n            )\n\n# Add current request to history\n        history.append(current_time)\n\n# Add rate limit headers\n        response = await call_next(request)\n        response.headers[\"X-RateLimit-Limit\"] = str(self.requests_per_minute)\n        response.headers[\"X-RateLimit-Remaining\"] = str(\n            self.requests_per_minute - len(history)\n        )\n        response.headers[\"X-RateLimit-Reset\"] = str(\n            int(current_time + self.window_size)\n        )",
  "code_samples": [],
  "headings": [],
  "url": "llms-txt#===-rate-limiting-middleware-===",
  "links": []
}